<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウェルビーイングと空間要素</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4d4d4d; --accent-pos: #d4a373; --accent-neg: #457b9d;
            --bg: #FFFFFF; --card-bg: #ffffff; --text: #222; --border: #eeeeee;
            --rank-red: #e74c3c;
        }
        body { font-family: "Klee One", cursive, "Helvetica Neue", Arial, "Hiragino Sans", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 80px; }
        @media screen and (max-width: 767px) { .container { padding: 10px; } }
        
        header { border-bottom: 0px solid var(--primary); margin-bottom: 10px; padding-bottom: 20px; display: flex; flex-direction: column; }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .print-btn {
            background: var(--primary); color: #fff; padding: 10px 25px; font-size: 0.8rem;
            letter-spacing: 0.2em; cursor: pointer; border: none; transition: 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .print-btn:hover { opacity: 0.8; transform: translateY(-2px); }

        .description-text { font-size: 1rem; font-weight: 600; color: #555; line-height: 1.8; margin-top: 20px; max-width: 1100px; white-space: pre-wrap; }
        .about-link { display: inline-block; margin-top: 10px; font-size: 0.9rem; color: var(--accent-pos); text-decoration: underline; cursor: pointer; }

        .config-panel { display: none; grid-template-columns: 350px 1fr; gap: 40px; background: white; padding: 30px; border: 1px solid var(--border); margin-bottom: 40px; }
        .target-section { display: flex; flex-direction: column; }
        .filter-panel { border-left: 1px solid var(--border); padding-left: 40px; }
        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        label { display: block; font-size: 0.65rem; font-weight: bold; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        select { width: 100%; padding: 10px; border: 1px solid var(--border); font-size: 0.85rem; background: #fff; border-radius: 0; }
        .target-select { font-family: "Klee One", cursive; font-size: 1rem; font-weight: 300; background: #fafafa; border-bottom: 2px solid var(--primary); }

        .comparison-layout { display: none; grid-template-columns: 1fr 1fr; gap: 40px; }
        .column-header { text-align: center; margin-bottom: 20px; padding: 10px; background: var(--primary); color: white; letter-spacing: 0.2em; font-weight: 200; text-transform: uppercase; font-size: 1rem; }
        .n-badge { font-size: 0.7rem; color: #aaa; margin-top: 5px; }

        .card-grid { display: flex; flex-direction: column; gap: 12px; min-height: 400px; }
        .card { 
            background: var(--card-bg); border: 1px solid var(--border); 
            display: flex; flex-direction: row; align-items: center;
            opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative; min-height: 100px;
        }
        .card.is-visible { opacity: 1; transform: translateY(0); }
        .card:hover { transform: translateX(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.05); border-color: var(--primary); }

        .rank-badge { position: absolute; top: 8px; left: 10px; z-index: 10; font-family: 'Georgia', serif; font-weight: bold; color: var(--text); font-size: 1.1rem; opacity: 0.3; text-shadow: 0 0 8px rgba(255,255,255,1); }
        .card-visual { width: 160px; height: 100px; overflow: hidden; background: #f7f7f7; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .card-visual img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 10px 25px; flex-grow: 1; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .card-label { font-size: 1rem; font-weight: 600; line-height: 1.4; flex-grow: 1; margin: 0; }
        .card-footer { display: flex; flex-direction: column; align-items: flex-end; min-width: 100px; }
        .r-value { font-size: 1.8rem; font-weight: 200; font-family: 'Georgia', serif; line-height: 1; }
        .pos { color: var(--accent-pos); } .neg { color: var(--accent-neg); }
        .r-unit { font-size: 0.5rem; color: #aaa; text-transform: uppercase; margin-top: 4px; }

        /* モーダル：境界と浮遊感を強化 */
        .modal { 
            display: none; position: fixed; z-index: 3000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); /* 少し暗くして浮遊感を出す */
            overflow-y: auto; 
        }
        .modal-content { 
            max-width: 900px; margin: 40px auto; padding: 60px; 
            background: #ffffff; /* モーダル本体は白 */
            border: 1px solid #ddd; /* 薄めの枠 */
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); /* 柔らかな影 */
            line-height: 1.8; color: #333; text-align: justify; 
            position: relative;
        }
        .modal-content h2 { font-size: 1.5rem; font-weight: 300; margin-bottom: 40px; border-bottom: 1px solid #4d4d4d; padding-bottom: 15px; }
        .modal-content h3 { font-size: 1.1rem; font-weight: 300; margin-top: 40px; margin-bottom: 20px; color: var(--primary); border-left: 4px solid var(--accent-pos); padding-left: 15px; }
        .modal-content p { margin-bottom: 1.5em; font-size: 0.95rem; }
        .modal-content ul { padding-left: 20px; font-size: 0.9rem; }
        .modal-content li { margin-bottom: 10px; }
        .close-modal { position: absolute; right: 30px; top: 30px; cursor: pointer; font-size: 2rem; opacity: 0.5; }
        .close-modal:hover { opacity: 1; }
        .ref-list { font-size: 0.8rem; color: #777; list-style: none; padding-left: 0; }

        @media (max-width: 1100px) { .comparison-layout, .config-panel { grid-template-columns: 1fr; } .filter-panel { border-left: none; padding-left: 0; border-top: 1px solid var(--border); padding-top: 20px; } }
    </style>
</head>
<body>

<div class="container" id="main-content">
    <header>
        <div class="header-top">
            <h1 style="font-size: 1.6rem; font-weight: 300; letter-spacing: 0.1em; margin:0;">ウェルビーイングと空間要素</h1>
            <button class="print-btn" onclick="generatePreview()">
                <i data-lucide="printer" size="16"></i> PRINT
            </button>
        </div>
        <p class="description-text">本サイトは、「主観的ウェルビーイング」と「空間の構成要素」の相関係数をもとに可視化するツールです。</p>
        <span class="about-link" onclick="openAbout()">本ツール作成の背景と、私たちについて</span>
        <div class="title-row" style="margin-top:20px;">
            <div id="total-n" style="font-size: 0.8rem; font-weight: bold; letter-spacing: 0.1em;">TOTAL N = 0</div>
        </div>
    </header>

    <div class="config-panel" id="main-ui">
        <div class="target-section">
            <label>Target Psychology</label>
            <select id="target-psychology" class="target-select" onchange="runSimulation()"></select>
        </div>
        <div class="filter-panel">
            <label>Attributes Filters</label>
            <div class="filter-grid" id="filters"></div>
        </div>
    </div>

    <div id="results-area" class="comparison-layout">
        <div class="column">
            <div class="column-header">住宅 <div class="n-badge" id="n-housing">N=0</div></div>
            <div class="card-grid" id="grid-housing"></div>
        </div>
        <div class="column">
            <div class="column-header">オフィス <div class="n-badge" id="n-office">N=0</div></div>
            <div class="card-grid" id="grid-office"></div>
        </div>
    </div>
</div>

<div id="aboutModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAbout()">&times;</span>
        <h2>本ツール作成の背景と、ウェルビーイング空間設計プロジェクト（仮）について</h2>
        
        <h3>私たちについて</h3>
        <p>ウェルビーイング空間設計プロジェクト（仮）は、建築物を発注する人やデザインする人、施工する人、実際に使う人など、建築にかかわるすべての人が、そのプロセスやアウトプットにおいて「居心地のよさ」を感じられることを目指しています。</p>
        <p>周知の通り、建築物は、世の中にあるそのほかの製作物と同様に、それをつくるプロセスや使われていくあいだにおいて、さまざまな人や組織が関わっています。それぞれが役割を持ち、つくられ使われることで、社会が営まれています。</p>
        <p>現代社会において、ほとんどの活動が、建築物のなかで行われていることを考えると、良い社会をつくり、営むということにおいて、建築物は大きな責任を負っていると考えます。つまり、居心地よくつくられ、居心地よく使われる建築物というあり方を目指すことは、よりよい社会をつくることにつながると私たちは考えています。</p>

        <h3>建築設計や施工に関わる人々の「めやす」として</h3>
        <p>しかし、その「居心地のよい空間や建築物」を作り出すための明確な基準が、世の中にはまだありません。予算や敷地面積など限られた条件のなかで、建築要素の何を優先することが、「居心地のよさ」につながるのでしょうか。天井高でしょうか？それとも窓の大きさでしょうか？</p>
        <p>これまでは、デザイナーや設計者の経験値や施主の想いなどをもとにつくられてきた「居心地のよさ」ですが、それは時に「ひとりよがり」となり、真の「居心地のよさ」にはつながっていないケースもあると思われます。</p>
        <p>もちろん、「居心地のよさ」は個人の主観であり、数値的には測れないものがほとんどかもしれません。しかし、先ほども述べたとおり、建築物はたくさんの人がチームとなり、多様な技術や知識を結集してつくられます。そのプロセスにおいて、それぞれが多様な能力を発揮するための「めやす」のようなものの必要性を感じ、本プロジェクトがスタートしました。</p>
        <p>本ツールが、居心地のよいプロセスで作られた居心地のよい建築物をつくる一助となり、使う人の居心地のよい空間と時間、よりよい社会へとつながっていくことを願っています。</p>

        <h3>調査対象と方法</h3>
        <p>日常生活の中で室内の滞在時間の長い住宅とオフィスを対象に、主観的ウェルビーイングに影響する構成要素のアンケートを実施し（有効回答数1,040 名）、相関分析によって住宅79 項目、オフィス70 項目、因子分析によって、住宅7 因子、オフィス7 因子の主観的ウェルビーイングに影響する構成要素を明らかにしました。</p>
        <p>本ツールは明らかにした構成要素をもとに、建築空間の構成要素を定量的かつ網羅的、具体的に提示し、主観的ウェルビーイングを高める空間づくりの要素をシミュレーションできるツールとして開発しました。<br>
        <a href="#" style="color:var(--accent-pos);">本調査についての詳細はこちら</a></p>

        <h3>本ツールの使い方</h3>
        <ul>
            <li><strong>Target Psychology:</strong> 向上させたい心理的指標（幸福度、満足度、気分など）を選択します。</li>
            <li><strong>Attribute Filters:</strong> 対象となる居住者の性別、年代、居住地方を絞り込むことができます。</li>
            <li><strong>Residential / Office:</strong> 住宅とオフィスにおける各建築要素の相関係数が、高い順（プラスの相関）にランキング形式で表示されます。</li>
            <li><strong>相関係数（Correlation）:</strong> 0.1以上を相関あり、0.2以上を弱い相関、0.4以上を中程度の相関として解釈します。</li>
        </ul>

        <h3>本ツールで採用している心理尺度について</h3>
        <p><strong>・人生満足度尺度（SWLS）：</strong>Diener らが主観的幸福感を計る目的で開発したもので、比較的長いスパンにおける主観的幸福度を確認する尺度とされている。本調査では、以下5 項目について質問した。「ほとんどの面で、私の人生は私の理想に近い」「私の人生は、とてもすばらしい状態だ」「私は自分の人生に満足している」「私はこれまで、自分の人生に求める大切なものを得てきた」「もう一度人生をやり直せるとしても、ほとんど何も変えないだろう」</p>
        <p><strong>・主体性4項目：</strong>（※ここに項目の詳細が入ります）</p>
        <p><strong>・ポジティブ感情（PA）/ ネガティブ感情（NA）：</strong>David Watson & Lee Anna Clark らが開発した気分評価尺度（日本語版PANAS）。ポジティブ感情「活気のある」「誇らしい」「強気な」等8項目、ネガティブ感情「びくびくした」「うろたえた」「心配した」等8項目の計16項目について、過去1ヶ月の体験を質問した。</p>
        <p><strong>・幸せの4因子：</strong>前野らが提唱する国内の幸福研究の主要概念。本調査では短縮版（8項目）を採用。「私は有能である」「私は社会・組織の要請に応えている」「私は人の喜ぶ顔が見たい」「私を大切に思ってくれる人たちがいる」等の項目について質問した。</p>

        <h3>ウェルビーイング空間設計プロジェクト（仮）メンバー</h3>
        <p>前野隆司　武蔵野大学ウェルビーイング学部長・教授、慶應義塾大学名誉教授<br>
        山形与志樹　慶應義塾大学大学院システムデザイン・マネジメント研究科 教授<br>
        （※残りのメンバーの方々をここに追加してください）</p>

        <h3 style="border-left:none; padding-left:0; border-top:1px solid #eee; padding-top:20px;">【引用文献】</h3>
        <ul class="ref-list">
            <li>・Diener, E., Emmons, R. A., Larsen, R. J., and Griffin, S.:The satisfaction with life scale, Journal of PersonalityAssessment, 49(1),pp.71-75, 1985.</li>
            <li>・佐藤徳，安田朝子：日本語版PANASの作成，性格心理学研究，9 （2），pp.138-139，2001．</li>
            <li>・前野隆司：幸せのメカニズム 実踐・幸福学入門,講談社現代新書,2013</li>
        </ul>
    </div>
</div>

<script>
let masterData = [];
let columns = { attr: [], psych: [], arch: [] };

function openAbout() { document.getElementById('aboutModal').style.display = "block"; document.body.style.overflow = "hidden"; }
function closeAbout() { document.getElementById('aboutModal').style.display = "none"; document.body.style.overflow = "auto"; }

const imageUrlMap = {
"地震による被害の心配はない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_7b44bd1a-fd60-49ab-80df-9c8c1daf0e5b.png",
"台風や豪雨による被害の心配はない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x248_webp_fd5730dc-6272-4cd4-9e50-15f4bef56725.png",
"泥棒や不審者が侵入する心配はない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_c550557a-f4bb-46a2-ade5-12a9a3118a3a.png",
"外の音が気にならない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_bcbeab9e-385d-49c4-bcac-a00b11bc42fa.png",
"外からの視線が気にならない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_98a7e1cb-1372-4ed5-aeb8-077f15c3c0e2.png",
"自分の居場所がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_ffef9cd5-c1b5-4db9-8277-331ac3486abd.png",
"快適な室温": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-467x247_webp_7629dabb-9c2e-41d4-9aeb-3a3a5dc96e66.png",
"快適な広さ": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_4059dea2-cf9f-42b9-a51b-dbf7263ce254.png",
"快適な天井高": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-467x247_webp_a8982c0f-e159-4e8d-a174-89d8b37ec23a.png",
"窓からの日当たりがよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-467x247_webp_1870a91d-0249-454a-99b8-b1848081753c.png",
"窓からの風通しがよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_24f5f493-954b-4db6-a657-cacf6f34c33b.png",
"窓からの眺めがよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_6ab0ce3c-8822-437b-b5fe-bb779f303655.png",
"テラスや縁側がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x248_webp_2860e1c8-44e9-4094-9a29-7d331474d685.png",
"心地よい照明がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_45dc4fcb-97f3-4dff-bd09-baae94b51769.png",
"見通しがよく全体を見渡せる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_30fdd1c6-6c78-464b-889a-26ea98b61c89.png",
"開放感がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_f549390f-21e2-4d07-a108-df91bb083f12.png",
"よい香りがする": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_fc110954-0bfa-4b4b-84d2-d7017fe0d5f7.png",
"自然を感じられる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_fbd1e7aa-b875-4063-9a61-56b4ffa92fba.png",
"空気や水がきれい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-468x249_webp_3adadf61-6947-447e-832e-9a9b71d75972.png",
"木材などの自然素材を使っている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_76d7740e-c064-4d3c-b850-d54c2e54d460.png",
"みんなで集まれる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_64a6c228-ce44-4a1b-9134-e825af27790b.png",
"食事が快適にとれる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-374x199_webp_9ec8abd2-5ded-4059-a84d-aa5648610c1a.png",
"快適な睡眠や仮眠をとれる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_ad98d7e0-ac2f-4932-848e-d9c73ceb04d5.png",
"快適なトイレがある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_285d53dc-4fa0-459e-be99-2476aa9b0047.png",
"いつも清潔に保たれている": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_eebe0339-ef38-43c7-b649-daae88880f53.png",
"浴室や洗面室で清潔な体を保てる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_335fe411-7502-463a-94a1-f21691a17d06.png",
"家具を自由にレイアウトできる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_b122d7fa-6f96-46ba-ad85-fd162c75cf90.png",
"建具の開閉などで空間を好きに使える": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x248_webp_8dc5d578-4044-480f-989c-54d77f5e4327.png",
"壁紙などを好きに変えられる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_96e914a0-0901-4297-aa09-5d3acf092aee.png",
"自分の個性を表現できる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_7cef425c-165e-4cff-a415-68abd0ff0112.png",
"壁に近い位置がよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_075df169-b298-4b58-9e09-ea50fcc21743.png",
"窓に近い位置がよい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_7a6780a3-4516-411b-b1df-2fdd8caa345c.png",
"好きに移動できる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_26016f2f-206f-40e9-9035-e4a06955af48.png",
"行きたい場所へ行きやすい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_686ea138-9992-4560-8fe6-c59c008d3546.png",
"過ごし方を好きに決められる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_bb7a27fa-eba7-4964-b030-ca4fc088f776.png",
"特定の用途がない空間がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_5a5e503f-bd93-4ace-903c-5792c6fd9604.png",
"芸術を楽しめる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_e4598144-1f48-4c79-a49c-3065f281aa45.png",
"コミュニケーションを取りやすい": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_7467e6d7-bae2-44bf-b5c1-68929d11ae80.png",
"ほかの人と適度な距離を保てる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_25795e35-cca3-4510-933f-1f982dd5d17a.png",
"ほかの人の視線が気にならない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-467x247_webp_5919edb8-c86c-425d-88d5-0de4d00be8ca.png",
"気を使わずに行動できる": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_3ca5c842-3887-483e-b7d4-b1fb7932a702.png",
"全体的に物が少ない": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_637e6864-1434-43f6-8a48-5d4b47891a2d.png",
"全体的に物が多い": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_055b15b4-0d8a-48de-a616-85ddfaaf84d6.png",
"快適に使用できる家具がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_eeda0058-1cd6-4bba-b886-81bba4320855.png",
"芸術作品がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_10adf594-3f01-4577-8251-330dd80ed848.png",
"観葉植物や生花がある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x247_webp_10efae1b-0f37-4d85-a013-82b1756e426c.png",
"好きなものがたくさんある": "https://storage.googleapis.com/studio-design-asset-files/projects/rROn1rzYWA/s-466x248_webp_ddf648dc-b926-4ee6-9b0f-218d09e4c5ec.png",
};

function superNormalize(s) { return s ? String(s).replace(/[\s\n\r（）\(\)]/g, "") : ""; }
const normMap = {}; for (let k in imageUrlMap) { normMap[superNormalize(k)] = imageUrlMap[k]; }

function getIconName(label) {
    const l = superNormalize(label);
    if (l.includes('安心')) return 'shield';
    if (l.includes('音')) return 'volume-2';
    return 'component';
}

const PSYCH_COLS = [10, 11, 12, 13, 18, 19, 20, 21, 22, 23, 24, 25, 28, 29, 31, 34, 35, 44];
const ARCH_COLS = [51, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99];
const REGION_ORDER = ["北海道・東北地方", "関東地方", "中部地方", "近畿地方", "中国・四国・九州・沖縄地方"];

window.onload = function () {
    Papa.parse("data.csv", {
        download: true, header: false, dynamicTyping: true, skipEmptyLines: true,
        complete: function (results) {
            const raw = results.data;
            masterData = raw.slice(2);
            columns.attr = [2, 3, 4].map(idx => ({ idx, name: raw[0][idx] }));
            columns.psych = PSYCH_COLS.map(idx => ({ idx, label: raw[1][idx] || raw[0][idx] }));
            columns.arch = ARCH_COLS.map(idx => ({ idx, label: raw[1][idx] || raw[0][idx] }));
            setupFilters();
            setupPsychList();
            document.getElementById('main-ui').style.display = 'grid';
            document.getElementById('results-area').style.display = 'grid';
            runSimulation();
        }
    });
};

function setupFilters() {
    const container = document.getElementById('filters'); container.innerHTML = '';
    columns.attr.forEach(col => {
        let uniqueValues = [...new Set(masterData.map(d => d[col.idx]))].filter(v => v != null);
        if (col.idx === 4) { uniqueValues.sort((a, b) => REGION_ORDER.indexOf(a) - REGION_ORDER.indexOf(b)); }
        else { uniqueValues.sort(); }
        const div = document.createElement('div');
        div.innerHTML = `<label>${col.name}</label><select class="filter-select" data-idx="${col.idx}" onchange="runSimulation()"><option value="all">ALL</option>${uniqueValues.map(v => `<option value="${v}">${v}</option>`).join('')}</select>`;
        container.appendChild(div);
    });
}

function setupPsychList() {
    document.getElementById('target-psychology').innerHTML = columns.psych.map(p => `<option value="${p.idx}">${p.label}</option>`).join('');
}

function calculateCorrelation(data, idxX, idxY) {
    const subset = data.filter(d => typeof d[idxX] === 'number' && typeof d[idxY] === 'number');
    const n = subset.length; if (n < 2) return 0;
    let sX=0, sY=0, sXY=0, sX2=0, sY2=0;
    for(let i=0; i<n; i++) {
        let x=subset[i][idxX], y=subset[i][idxY];
        sX+=x; sY+=y; sXY+=x*y; sX2+=x*x; sY2+=y*y;
    }
    const num = (n*sXY)-(sX*sY), den = Math.sqrt(((n*sX2)-(sX*sX))*((n*sY2)-(sY*sY)));
    return den===0 ? 0 : num / den;
}

function renderGrid(gridId, nId, data, targetIdx) {
    const grid = document.getElementById(gridId);
    const nDisplay = document.getElementById(nId);
    const results = columns.arch.map(a => ({ label: a.label, r: calculateCorrelation(data, targetIdx, a.idx) })).sort((a, b) => b.r - a.r);
    nDisplay.innerText = `N = ${data.length}`;
    grid.innerHTML = '';
    results.forEach((res, i) => {
        if (Math.abs(res.r) < 0.01) return;
        const img = normMap[superNormalize(res.label)];
        const visual = img ? `<img src="${img}" loading="lazy">` : `<div class="icon-placeholder"><i data-lucide="component" size="32"></i></div>`;
        const card = document.createElement('div');
        card.className = 'card is-visible';
        card.innerHTML = `<div class="rank-badge">${i+1}</div><div class="card-visual">${visual}</div><div class="card-content"><div class="card-label">${res.label}</div><div class="card-footer"><span class="r-value ${res.r>=0?'pos':'neg'}">${res.r.toFixed(2)}</span><span class="r-unit">Correlation</span></div></div>`;
        grid.appendChild(card);
    });
    lucide.createIcons();
}

function runSimulation() {
    const selects = document.querySelectorAll('.filter-select');
    let filteredTotal = masterData;
    selects.forEach(s => { if (s.value !== 'all') { const val = isNaN(s.value) ? s.value : Number(s.value); filteredTotal = filteredTotal.filter(d => d[s.dataset.idx] === val); }});
    const targetIdx = parseInt(document.getElementById('target-psychology').value);
    renderGrid('grid-housing', 'n-housing', filteredTotal.filter(d => superNormalize(String(d[9])) === "住宅"), targetIdx);
    renderGrid('grid-office', 'n-office', filteredTotal.filter(d => superNormalize(String(d[9])) === "オフィス"), targetIdx);
}

function generatePreview() {
    const targetSelect = document.getElementById('target-psychology');
    const targetText = targetSelect.options[targetSelect.selectedIndex].text;
    const filterInfo = Array.from(document.querySelectorAll('.filter-select')).map(s => `${s.previousElementSibling.innerText}: ${s.value === 'all' ? 'ALL' : s.value}`).join(' / ');
    const win = window.open("", "_blank");
    win.document.write(`<html><head><title>Preview</title><style>body { font-family: "Klee One", cursive; padding: 20px; color: #333; background: #525659; display: flex; flex-direction: column; align-items: center; }.page { background: white; width: 210mm; height: 296mm; padding: 15mm; box-shadow: 0 0 20px rgba(0,0,0,0.5); box-sizing: border-box; overflow: hidden; position: relative; }.header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }.title { font-size: 1.3rem; margin: 0; font-weight: 600; }.meta-box { background: #f5f5f5; padding: 12px; margin-bottom: 15px; font-size: 0.75rem; border: 1px solid #eee; }.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }.col-title { background: #000; color: #fff; text-align: center; padding: 4px; font-size: 0.7rem; margin-bottom: 10px; }.item-row { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 4px 0; font-size: 0.62rem; }.rank { width: 15px; color: #999; font-weight: bold; }.img-thumb { width: 45px; height: 28px; object-fit: cover; margin: 0 10px; border: 1px solid #eee; }.label { flex-grow: 1; margin-right: 8px; line-height: 1.1; }.val { font-weight: bold; font-size: 0.85rem; }.btn-area { margin-bottom: 20px; }.dl-btn { background: #d4a373; color: white; border: none; padding: 12px 30px; cursor: pointer; font-weight: bold; }</style></head><body><div class="btn-area"><button class="dl-btn" onclick="window.parent.exportPDF(document.getElementById('pdf-root'), '${targetText}')">PDFを保存</button></div><div class="page" id="pdf-root"><div class="header"><div class="title">ウェルビーイングと空間要素</div></div><div class="meta-box"><strong>Target:</strong> ${targetText} | <strong>Filters:</strong> ${filterInfo}</div><div class="grid">\${['住宅', 'オフィス'].map((type, i) => { const gridId = i === 0 ? 'grid-housing' : 'grid-office'; const nVal = document.getElementById(i === 0 ? 'n-housing' : 'n-office').innerText; const cards = Array.from(document.getElementById(gridId).querySelectorAll('.card')).slice(0, 10); return '<div><div class="col-title">' + type + ' (' + nVal + ')</div>' + cards.map((card, idx) => { const label = card.querySelector('.card-label').innerText; const val = card.querySelector('.r-value').innerText; const img = card.querySelector('img') ? card.querySelector('img').src : ''; return '<div class="item-row"><div class="rank">' + (idx + 1) + '</div>' + (img ? '<img src="' + img + '" class="img-thumb">' : '<div class="img-thumb" style="background:#f0f0f0"></div>') + '<div class="label">' + label + '</div><div class="val">' + val + '</div></div>'; }).join('') + '</div>'; }).join('')}</div><div style="position: absolute; bottom: 15mm; width: calc(100% - 30mm); font-size: 0.55rem; color: #999; text-align: center; border-top: 1px solid #eee; padding-top: 8px;">※ 本データは統計的相関を示すものであり、因果関係を保証するものではありません。</div></div></body></html>`);
    win.document.close();
    win.exportPDF = (element, title) => { const opt = { margin: 0, filename: `ウェルビーイングと空間要素_${title}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 3, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; html2pdf().set(opt).from(element).save(); };
}
</script>
</body>
</html>
